
#cloud-config

package_update: true
package_upgrade: true
packages:
  - curl
  - ca-certificates
  - git
  - python3
  - python3-venv
  - nodejs
  - npm
  - apt-transport-https

write_files:
  - path: /opt/bootstrap/bootstrap.sh
    permissions: "0755"
    content: |
      #!/usr/bin/env bash
      set -euo pipefail

      LOG_BOOTSTRAP="/var/log/bootstrap.log"

      ZIP_URL="https://raw.githubusercontent.com/dloder0/XDROps/main/XDROps.tar.gz"

      echo "[bootstrap] Downloading installer package from $ZIP_URL" | tee -a "$LOG_BOOTSTRAP"

      mkdir -p /opt/bootstrap

      curl -fsSL "$ZIP_URL" -o /opt/bootstrap/XDROps.tar.gz

      tar -xzf /opt/bootstrap/XDROps.tar.gz -C /opt/bootstrap

      # --- Determine hostname ---
      HOSTNAME_MATCH=$(hostname)

      echo "[bootstrap] System hostname: $HOSTNAME_MATCH" | tee -a "$LOG_BOOTSTRAP"

      # --- Look for a matching file ---
      MATCHING_FILE="/opt/bootstrap/$HOSTNAME_MATCH.sh"

      if [[ -f "$MATCHING_FILE" ]]; then
          echo "[bootstrap] Found matching file: $MATCHING_FILE" | tee -a "$LOG_BOOTSTRAP"
          chmod +x "$MATCHING_FILE"
          echo "Running $MATCHING_FILE..."
          "$MATCHING_FILE"
      else
          echo "[bootstrap] No file matching hostname found." | tee -a "$LOG_BOOTSTRAP"
      fi

      echo "[bootstrap] Completed." | tee -a "$LOG_BOOTSTRAP"


runcmd:
  - [ bash, -lc, "/opt/bootstrap/bootstrap.sh" ]
